# vib
name: Moonflyers Vanilla Desktop # Replace this name with your image name
id: moonflyer # Replace this ID with your image ID

# stages
stages:
- id: build
  base: ghcr.io/vanilla-os/nvidia:main # Optionally, Replace this image URL with a different one i.e. nvidia:main, etc
  singlelayer: false
  labels:
    maintainer: self-maintained # Optionally, Replace this with your name
  args:
    DEBIAN_FRONTEND: noninteractive # Set the image environment as non-interactive
  
# Commands to run first before building the modules
  runs:
    commands:
      - echo 'APT::Install-Recommends "1";' > /etc/apt/apt.conf.d/01norecommends

  modules:
    - name: init-setup
      type: shell
      commands:
      - lpkg --unlock
      - apt-get update

# BEGIN custom actions
    
    - name: syncthing # apt do installs
      type: apt
      source:
        packages:
        - syncthing
        - eza

    - name: virt-dependencies
      type: apt
      source:
        packages:
        - virt-manager
        - openssh-server
        - libvirt-daemon-system
        - libvirt-clients
        - qemu-system qemu-utils

    - name: usb-share-fix
      type: shell
      commands:
        - cp  /usr/share/polkit-1/actions/_org.spice-space.lowlevelusbaccess.policy  /usr/share/polkit-1/actions/org.spice-space.lowlevelusbaccess.policy

    - name: set-libvirt-group
      type: shell
      commands:
        - chmod +x /etc/profile.d/add_libvirt_group.sh
    
    - name: install-tcc # Install Tuxedo Software
      type: shell
      commands:
        - wget http://deb.tuxedocomputers.com/ubuntu/pool/main/t/tuxedo-drivers/tuxedo-drivers_4.6.1_all.deb
        - wget http://deb.tuxedocomputers.com/ubuntu/pool/main/t/tuxedo-control-center/tuxedo-control-center_2.1.12-3_amd64.deb
        - dpkg -i tuxedo-drivers_4.6.1_all.deb
        - dpkg -i tuxedo-control-center_2.1.12-3_amd64.deb
    
  # END custom actions

    - name: set-image-name-abroot
      type: includes
      includes:
        - modules/80-set-image-abroot-config.yml

    - name: cleanup
      type: shell
      commands:
      - apt-get autoremove -y
      - apt-get clean
      - lpkg --lock

    - name: fsguard
      type: fsguard
      CustomFsGuard: false
      FsGuardLocation: "/usr/sbin/FsGuard"
      GenerateKey: true
      FilelistPaths: ["/usr/bin"]
      modules:
        - name: remove-prev-fsguard
          type: shell
          commands:
            - rm -rf /FsGuard 
            - rm -f ./minisign.pub ./minisign.key 
            - chmod +x /usr/sbin/init

    - name: cleanup2
      type: shell
      commands:
        - rm -rf /tmp/*
        - rm -rf /var/tmp/*
        - rm -rf /sources
